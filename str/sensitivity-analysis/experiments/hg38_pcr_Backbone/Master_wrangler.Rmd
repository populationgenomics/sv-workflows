---
title: "trf_output"
author: "Hope"
date: "15/02/2023"
output: html_document
---

```{r}
library('rjson')
library('spgs')
```

```{r}
trf_output = fromJSON(file = "filtered_trf_output_modified.txt") %>% as.data.frame() %>% gather() 
trf_output = trf_output %>% mutate (key = case_when(key == "X16PTEL06"~ "16PTEL06",
                                       key == "X18QTEL11"~ "18QTEL11",
                                       key == "X2QTEL47" ~ "2QTEL47",
                                       key == "X4PTEL04"~ "4PTEL04",
                                       key == "MFD424.TTTA003"~ "MFD424-TTTA003",
                                       key == "MFD442.GTTT002" ~ "MFD442-GTTT002",
                                       key == "MFD455.AAT052"~"MFD455-AAT052",
                                       TRUE ~ key))
```
`

```{r}
fasta = read_excel("482_loci_with_primers_UCSC_remove_fix_alt.xlsx") %>% select(-...1)
fasta$coordinate = gsub("\r\n", " ", fasta$coordinate)
fasta$coordinate = str_trim(fasta$coordinate, side = "both")
fasta = fasta %>% filter(coordinate != "no match")%>% separate(coordinate, c("coordinates", "PCR_length", "forward_primer", "reverse_primer", "PCR_sequence_1", "PCR_sequence_2", "PCR_sequence_3", "PCR_sequence_4", "PCR_sequence_5", "PCR_sequence_6", "PCR_sequence_7", "PCR_sequence_8"), sep = " ")

fasta = fasta %>% mutate(PCR_sequence_2 = replace_na(PCR_sequence_2, ""),
                  PCR_sequence_3 = replace_na(PCR_sequence_3, ""),
                  PCR_sequence_4 = replace_na(PCR_sequence_4, ""),
                  PCR_sequence_5 = replace_na(PCR_sequence_5, ""),
                  PCR_sequence_6 = replace_na(PCR_sequence_6, ""),
                  PCR_sequence_7 = replace_na(PCR_sequence_7, ""),
                  PCR_sequence_8 = replace_na(PCR_sequence_8, "")
  
)

fasta$PCR_sequence = paste(fasta$PCR_sequence_1, fasta$PCR_sequence_2, fasta$PCR_sequence_3, fasta$PCR_sequence_4, fasta$PCR_sequence_5, fasta$PCR_sequence_6, fasta$PCR_sequence_7, fasta$PCR_sequence_8)

fasta$PCR_sequence = gsub(" ", "", fasta$PCR_sequence)

fasta = fasta %>% select(-PCR_sequence_1, -PCR_sequence_2, - PCR_sequence_3, -PCR_sequence_4, -PCR_sequence_5, -PCR_sequence_6, -PCR_sequence_7, -PCR_sequence_8, -forward_primer, -reverse_primer)

fasta$PCR_length = gsub("bp", "", fasta$PCR_length)
```

```{r}
fasta = merge(trf_output, fasta, all.y = TRUE, by.x = "key", by.y = "alternateName")
fasta = fasta %>% separate(value, c("trf_start_index", "trf_end_index", "trf_period", "trf_num_repeats", "trf_size_consensus", "trf_percent_match", "trf_percent_indels", "trf_alignment", "trf_percent_composition_1", "trf_percent_composition_2", "trf_percent_composition_3", "trf_percent_composition_4", "trf_entropy", "trf_motif", "trf_repeat_sequence"), sep = " ")
fasta= fasta %>% mutate(sense = case_when(
  grepl("-", coordinates)~"antisense",
  grepl("+", coordinates)~ "sense",
  TRUE ~ "nosense"
))
fasta = fasta %>% separate(coordinates, c("chr", "coordinates"), sep = ":") %>% separate(coordinates, c("start_coordinate_PCR", "end_coordinate_PCR"), sep = "[+|-]") 

fasta$chr = gsub(">", "", fasta$chr)

fasta$trf_start_index = as.numeric(fasta$trf_start_index)
fasta$trf_end_index = as.numeric(fasta$trf_end_index)
fasta$end_coordinate_PCR = as.numeric(fasta$end_coordinate_PCR)
fasta$start_coordinate_PCR = as.numeric(fasta$start_coordinate_PCR)

fasta = fasta %>% mutate(catalog_start_coordinate = case_when(
  sense == "sense" ~ start_coordinate_PCR + trf_start_index-2, 
  sense== "antisense" ~ end_coordinate_PCR - trf_end_index
),
  catalog_end_coordinate = case_when(
sense == "sense"  ~start_coordinate_PCR + trf_end_index -1,
sense == "antisense" ~ end_coordinate_PCR - trf_start_index+1

  )
)

fasta = fasta %>% mutate ( trf_repeat_sequence = case_when(
                  sense == "antisense"~ reverseComplement(trf_repeat_sequence),
                  TRUE ~ trf_repeat_sequence)  
                  )

trf_input = fasta %>% filter(sense == "antisense") %>% select(chr,catalog_start_coordinate, catalog_end_coordinate, trf_repeat_sequence)
trf_input$name = paste(">",trf_input$chr,":" ,trf_input$catalog_start_coordinate, "-", trf_input$catalog_end_coordinate, sep = "")
trf_input = trf_input %>% select(name, trf_repeat_sequence)

#write.table(trf_input, file = "trf_input_antisense.txt", sep = "\n", row.names = FALSE, quote = FALSE)


```

```{r}
trf_output_antisense = read.csv("trf_output_antisense.txt") %>% separate(sequence, c("chr","coordinates" ), sep = ":") %>% separate(coordinates, c("catalog_start_coordinate", "catalog_end_coordinate"), sep = "-") %>% rename("updated_motif" = "motif")
```


```{r}
fasta = merge(fasta, trf_output_antisense, by = c("chr", "catalog_start_coordinate", "catalog_end_coordinate"), all.x = TRUE)
```

```{r}
fasta = fasta %>% mutate(trf_motif = case_when(sense == "antisense"~ updated_motif,
                                       TRUE ~trf_motif))
fasta = fasta %>% select(-updated_motif)
```

```{r}
gangstr_catalog = fasta %>% select(chr,catalog_start_coordinate, catalog_end_coordinate, trf_motif) %>% mutate(motif_len= nchar(trf_motif)) %>% select(chr, catalog_start_coordinate, catalog_end_coordinate, motif_len, trf_motif)

write.table(gangstr_catalog, file = "catalogs/gangstr_catalog_hg38_backbone.bed", sep = "\t", row.names = FALSE, quote = FALSE)
```

